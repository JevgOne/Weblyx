<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ğŸ”¥ Test Storage Rules - Weblyx</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #06B6D4; }
    .card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .status {
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-weight: 500;
    }
    .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }

    button {
      background: #06B6D4;
      color: white;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    button:hover { background: #0891b2; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    input[type="file"] {
      padding: 10px;
      margin: 10px 0;
      border: 2px dashed #06B6D4;
      border-radius: 5px;
      width: 100%;
      cursor: pointer;
    }

    #log {
      background: #2d3748;
      color: #48bb78;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.6;
    }

    .step {
      background: #e6fffa;
      padding: 10px 15px;
      margin: 10px 0;
      border-left: 4px solid #06B6D4;
      border-radius: 3px;
    }

    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ”¥ Test Firebase Storage Upload</h1>

    <div class="status info">
      <strong>ğŸ“ Projekt:</strong> weblyx-prod-38054<br>
      <strong>ğŸ¯ ÃšÄel:</strong> OvÄ›Å™enÃ­ Å¾e Storage Rules jsou sprÃ¡vnÄ› nasazenÃ©<br>
      <strong>âš¡ OÄekÃ¡vanÃ½ vÃ½sledek:</strong> Upload probÄ›hne za 2-5 sekund
    </div>

    <div id="authStatus" class="status warning">
      â³ Kontrolujem Firebase Auth...
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“¤ Upload Test</h2>

    <div class="step">
      <strong>1.</strong> Nejprve se pÅ™ihlas do admin panelu:
      <a href="https://weblyx.cz/admin" target="_blank">https://weblyx.cz/admin</a>
    </div>

    <div class="step">
      <strong>2.</strong> Pak se vraÅ¥ sem a vyber obrÃ¡zek
    </div>

    <input type="file" id="fileInput" accept="image/*">
    <button onclick="testUpload()" id="uploadBtn">ğŸš€ Spustit Upload Test</button>

    <div id="status"></div>
  </div>

  <div class="card">
    <h3>ğŸ“‹ Live Log</h3>
    <div id="log"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDB3aZX7dfRF7qKWH9JRf05cJCctfKNWvE",
      authDomain: "weblyx-prod-38054.firebaseapp.com",
      projectId: "weblyx-prod-38054",
      storageBucket: "weblyx-prod-38054.firebasestorage.app",
      messagingSenderId: "440732433732",
      appId: "1:440732433732:web:be17be9c62a18e9c54ae08"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const auth = getAuth(app);

    let logDiv = document.getElementById('log');
    let statusDiv = document.getElementById('status');
    let authStatusDiv = document.getElementById('authStatus');
    let uploadBtn = document.getElementById('uploadBtn');

    function log(message, emoji = 'ğŸ“') {
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div>[${time}] ${emoji} ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function showStatus(message, type) {
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // Check auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        log(`PÅ™ihlÃ¡Å¡enÃ½ uÅ¾ivatel: ${user.email}`, 'âœ…');
        authStatusDiv.className = 'status success';
        authStatusDiv.innerHTML = `<strong>âœ… PÅ™ihlÃ¡Å¡en jako:</strong> ${user.email}<br><strong>UID:</strong> ${user.uid.substring(0, 10)}...`;
        uploadBtn.disabled = false;
      } else {
        log(`NEJSI PÅ˜IHLÃÅ ENÃ! Jdi na admin panel a pÅ™ihlas se.`, 'âš ï¸');
        authStatusDiv.className = 'status error';
        authStatusDiv.innerHTML = `
          <strong>âŒ NEJSI PÅ˜IHLÃÅ ENÃ!</strong><br><br>
          <strong>Å˜eÅ¡enÃ­:</strong><br>
          1. OtevÅ™i v novÃ©m tabu: <a href="https://weblyx.cz/admin" target="_blank">https://weblyx.cz/admin</a><br>
          2. PÅ™ihlas se<br>
          3. VraÅ¥ se sem a zkus znovu
        `;
        uploadBtn.disabled = true;
      }
    });

    window.testUpload = async function() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!file) {
        alert('âŒ Vyber nejdÅ™Ã­v obrÃ¡zek!');
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        showStatus('âŒ NEJSI PÅ˜IHLÃÅ ENÃ! OtevÅ™i admin panel a pÅ™ihlas se.', 'error');
        return;
      }

      logDiv.innerHTML = ''; // Clear log
      log(`ğŸ“ Soubor: ${file.name}`, 'ğŸ“');
      log(`ğŸ“Š Velikost: ${(file.size / 1024).toFixed(2)} KB`, 'ğŸ“Š');
      log(`ğŸ‘¤ User ID: ${user.uid.substring(0, 10)}...`, 'ğŸ‘¤');
      log(`ğŸ”‘ Email: ${user.email}`, 'ğŸ”‘');

      showStatus('â³ NahrÃ¡vÃ¡m obrÃ¡zek do Firebase Storage...', 'info');
      uploadBtn.disabled = true;

      try {
        const timestamp = Date.now();
        const fileName = `test/${timestamp}_${file.name}`;
        const storageRef = ref(storage, fileName);

        log(`ğŸ“¤ Upload path: ${fileName}`, 'ğŸ“¤');
        log(`â±ï¸  ÄŒas zaÄÃ¡tku: ${new Date().toLocaleTimeString()}`, 'â±ï¸');

        const uploadStart = Date.now();

        // Upload with timeout
        const uploadPromise = uploadBytes(storageRef, file);
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('TIMEOUT - Upload trval dÃ©le neÅ¾ 30s')), 30000)
        );

        await Promise.race([uploadPromise, timeoutPromise]);

        const uploadDuration = ((Date.now() - uploadStart) / 1000).toFixed(2);
        log(`âœ… Upload dokonÄen za ${uploadDuration}s!`, 'âœ…');

        log(`ğŸ”— ZÃ­skÃ¡vÃ¡m download URL...`, 'ğŸ”—');
        const downloadURL = await getDownloadURL(storageRef);
        log(`âœ… Download URL zÃ­skÃ¡na`, 'âœ…');

        showStatus(`
          <strong>âœ… ÃšSPÄšCH!</strong><br><br>
          <strong>â±ï¸ ÄŒas uploadu:</strong> ${uploadDuration}s<br>
          <strong>ğŸ“‚ Path:</strong> ${fileName}<br><br>
          <strong>ğŸ”— URL:</strong><br>
          <a href="${downloadURL}" target="_blank" style="word-break: break-all; font-size: 12px;">${downloadURL}</a><br><br>
          <img src="${downloadURL}" style="max-width: 100%; margin-top: 10px; border-radius: 5px;" />
        `, 'success');

        log(`ğŸ‰ STORAGE RULES FUNGUJÃ SPRÃVNÄš!`, 'ğŸ‰');

      } catch (error) {
        const errorDuration = ((Date.now() - uploadStart) / 1000).toFixed(2);
        log(`âŒ CHYBA po ${errorDuration}s: ${error.message}`, 'âŒ');
        log(`âŒ Error code: ${error.code}`, 'âŒ');

        let help = '';
        let helpClass = 'error';

        if (error.code === 'storage/unauthorized') {
          help = `
            <strong>âŒ Storage/Unauthorized</strong><br><br>
            <strong>ğŸ” DiagnÃ³za:</strong> Storage Rules NEJSOU sprÃ¡vnÄ› nasazenÃ© v Firebase Console<br><br>
            <strong>âœ… Å˜eÅ¡enÃ­:</strong><br>
            1. OtevÅ™i: <a href="https://console.firebase.google.com/project/weblyx-prod-38054/storage/weblyx-prod-38054.firebasestorage.app/rules" target="_blank">Firebase Console â†’ Storage Rules</a><br>
            2. OtevÅ™i soubor: <strong>NASAÄ_STORAGE_RULES.md</strong> v projektu<br>
            3. ZkopÃ­ruj Rules z toho souboru<br>
            4. VloÅ¾ do Firebase Console<br>
            5. Klikni "Publish"<br>
            6. PoÄkej 1 minutu<br>
            7. Zkus znovu
          `;
        } else if (error.message.includes('TIMEOUT')) {
          help = `
            <strong>â±ï¸ Timeout</strong><br><br>
            <strong>ğŸ” DiagnÃ³za:</strong> Upload se zasekl - pravdÄ›podobnÄ› Storage Rules problÃ©m<br><br>
            <strong>âœ… Å˜eÅ¡enÃ­:</strong> StejnÃ© jako vÃ½Å¡e - nasaÄ Storage Rules
          `;
        } else if (error.message.includes('NEJSI PÅ˜IHLÃÅ ENÃ')) {
          help = `
            <strong>ğŸ” NepÅ™ihlÃ¡Å¡enÃ½</strong><br><br>
            <strong>âœ… Å˜eÅ¡enÃ­:</strong> OtevÅ™i <a href="https://weblyx.cz/admin" target="_blank">admin panel</a> a pÅ™ihlas se
          `;
        } else {
          help = `
            <strong>âŒ NeznÃ¡mÃ¡ chyba</strong><br><br>
            <pre>${JSON.stringify(error, null, 2)}</pre>
          `;
        }

        showStatus(help, 'error');

      } finally {
        uploadBtn.disabled = false;
      }
    };

    log('ğŸš€ Test pÅ™ipraven!', 'ğŸš€');
    log('âš ï¸  NezapomeÅˆ se pÅ™ihlÃ¡sit do admin panelu!', 'âš ï¸');
  </script>
</body>
</html>
